<!DOCTYPE html>
<html>
<head>
    <title>Email Info</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>
<h3>Email Info</h3>
<p><strong>Subject:</strong> <span id="subject">Loading...</span></p>
<p><strong>From:</strong> <span id="from"></span></p>
<p><strong>To:</strong> <span id="to"></span></p>
<p><strong>CC:</strong> <span id="cc"></span></p>
<h4>Body (Plain Text):</h4>
<pre id="bodyText">Loading...</pre>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const baseURL = 'https://deepaksinghdelhi96.freshdesk.com/api/v2';
    const headers = {
      "Authorization": "Basic YlRnRnN2SnR1V2VHbjRJdFU5UTM6", // Replace with your Freshdesk API key (Base64-encoded)
      "Content-Type": "application/json"
    };
    Office.onReady(info => {
      if (info.host === Office.HostType.Outlook) {
        const item = Office.context.mailbox.item;
        const subject = "None";
        const description = "None";
        const email = "None";

        // ✅ Subject (string in read mode)
        document.getElementById("subject").innerText = item.subject;
        subject = item.subject;

        // ✅ From
        if (item.from) {
          document.getElementById("from").innerText =
            `${item.from.displayName} <${item.from.emailAddress}>`;
            email = `${item.from.displayName} <${item.from.emailAddress}>`;
        }

        // ✅ To Recipients
        const toRecipients = item.to || [];
        document.getElementById("to").innerText =
          toRecipients.map(r => `${r.displayName} <${r.emailAddress}>`).join(', ');

        // ✅ CC Recipients
        const ccRecipients = item.cc || [];
        document.getElementById("cc").innerText =
          ccRecipients.map(r => `${r.displayName} <${r.emailAddress}>`).join(', ');

        // ✅ Body (plain text)
        item.body.getAsync(Office.CoercionType.Text, result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            document.getElementById("bodyText").innerText = result.value;
            description = result.value;
          } else {
            document.getElementById("bodyText").innerText = "Failed to load body.";
            description = "Failed to load body.";
          }
        });
        const payload = {
          subject,
          description,
          email,
          priority: 1,
          status: 2
        };

        try {
          const res = await fetch(`${baseURL}/tickets`, {
            method: 'POST',
            headers,
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            alert('✅ Ticket created successfully!');
          } else {
            const err = await res.json();
            alert('❌ Failed: ' + (err.message || res.statusText));
          }
        } catch (err) {
          alert('❌ Error: ' + err.message);
        }

      }
    });
</script>
</body>
</html>
