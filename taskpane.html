<!DOCTYPE html>
<html>
<head>
  <title>Email Info</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body class="p-3">
  <h3>Freshdesk</h3>
<!--   <p><strong>Subject:</strong> <span id="subject">Loading...</span></p>
  <p><strong>From:</strong> <span id="from"></span></p>
  <p><strong>To:</strong> <span id="to"></span></p>
  <p><strong>CC:</strong> <span id="cc"></span></p>
  <h4>Body (Plain Text):</h4>
  <pre id="bodyText">Loading...</pre> -->

  <button id="createTicketBtn" class="btn btn-primary mt-3">Create Ticket</button>

  <div id="ticketMsg" class="mt-3"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const baseURL = 'https://deepaksinghdelhi96.freshdesk.com/api/v2';
    const headers = {
      "Authorization": "Basic YlRnRnN2SnR1V2VHbjRJdFU5UTM6", // Base64-encoded API key
      "Content-Type": "application/json"
    };

     const emailData = {
      subject: "",
      email: "",
      description: ""
    };

    Office.onReady(info => {
      if (info.host === Office.HostType.Outlook) {
        const item = Office.context.mailbox.item;

        // Subject
        emailData.subject = item.subject || "(No Subject)";
        document.getElementById("subject").innerText = emailData.subject;

        // From
        if (item.from) {
          const fromText = `${item.from.displayName} <${item.from.emailAddress}>`;
          document.getElementById("from").innerText = fromText;
          emailData.email = item.from.emailAddress;
        }

        // To
        const to = (item.to || []).map(r => `${r.displayName} <${r.emailAddress}>`).join(', ');
        document.getElementById("to").innerText = to;

        // CC
        const cc = (item.cc || []).map(r => `${r.displayName} <${r.emailAddress}>`).join(', ');
        document.getElementById("cc").innerText = cc;

        // Body (wait until getAsync completes)
        item.body.getAsync(Office.CoercionType.Text, result => {
          if (result.status === Office.AsyncResultStatus.Succeeded) {
            emailData.description = result.value;
            document.getElementById("bodyText").innerText = result.value;
          } else {
            emailData.description = "Could not load email body.";
            document.getElementById("bodyText").innerText = "Failed to load body.";
          }
        });
      }
    });

    document.getElementById("createTicketBtn").addEventListener("click", async () => {
      const { subject, email, description } = emailData;

      if (!email || !description) {
        document.getElementById("ticketMsg").innerHTML = `⚠️ Please wait until email and body are fully loaded.`;
        return;
      }

      const payload = {
        subject,
        email,
        description,
        priority: 1,
        status: 2
      };

      const msgBox = document.getElementById("ticketMsg");
      msgBox.innerHTML = "⏳ Creating ticket...";

      try {
        const res = await fetch(`${baseURL}/tickets`, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.ok) {
          msgBox.innerHTML = `
            ✅ <strong>Ticket created successfully!</strong><br>
            Ticket ID: <code>${data.id}</code>
          `;
        } else {
          msgBox.innerHTML = `❌ Failed: ${data.message || res.statusText}`;
        }
      } catch (err) {
        msgBox.innerHTML = `❌ Error: ${err.message}`;
      }
    });

  </script>
</body>
</html>
